<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=300">
    <title>WordClock Settings</title>
    <link rel="stylesheet" href="index.css">
</head>
<body onload="loadSettings();">

<script src="jscolor.js"></script>

<div class="header">WordClock Settings</div>

<div class="outer_frame">
    <p>Farben</p>
    <div class="buttondiv">
    <button
        id = "foregroundColorButton"
        class="colorbutton jscolor {width:150,onFineChange:'newForeground=this.toString()',valueElement:null,value:'ffffff'}">
        wird geladen...
    </button>
    </div>

    <div class="buttondiv">
    <button
        id = "backgroundColorButton"
        class="colorbutton jscolor {width:150,onFineChange:'newBackground=this.toString()',valueElement:null,value:'000000'}">
        wird geladen...
    </button>
    </div>

    <div class="buttondiv">
    <button
        id = "secondsColorButton"
        class="colorbutton jscolor {width:150,onFineChange:'newSeconds=this.toString()',valueElement:null,value:'400020'}">
        wird geladen...
    </button>
    </div>
</div>

<div class="outer_frame">
    <p>Modus</p>
	<select style="width: 85%;" name="displaymode" id="displaymode" onchange="changeVar(this.id, this.selectedIndex)">
		<option>Einfach</option>
		<option>Weiche Übergänge</option>
		<option>Fliegende Buchstaben aufwärts</option>
		<option>Fliegende Buchstaben abwärts</option>
		<option>Explodierende Buchstaben</option>
		<option>Zufällig</option>
        <option>Matrix</option>
        <option>Herz</option>
        <option>Feuer</option>
        <option>Plasma</option>
        <option>Sterne</option>
	</select>
	<select style="width: 85%;" name="minutemode" id="minutemode" onchange="changeVar(this.id, this.selectedIndex)">
		<option>Viertel vor</option>
		<option>Dreiviertel</option>
	</select>
    <select style="width: 85%;" name="minuteTemplate" id="minuteTemplate" onchange="changeVar(this.id, this.selectedIndex)">
		<option>Layout 1</option>
		<option>Layout 2</option>
		<option>Layout 3</option>
	</select>
</div>

<div class="outer_frame">
    <p>Zeitzone</p>
	<select name="timezone" id="timezone" onchange="changeVar(this.id, this.selectedIndex-12)">
		<option>UTC-12:00</option>
		<option>UTC-11:00</option>
		<option>UTC-10:00</option>
		<option>UTC-09:00</option>
		<option>UTC-08:00</option>
		<option>UTC-07:00</option>
		<option>UTC-06:00</option>
		<option>UTC-05:00</option>
		<option>UTC-04:00</option>
		<option>UTC-03:00</option>
		<option>UTC-02:00</option>
		<option>UTC-01:00</option>
		<option>UTC+00:00</option>
		<option>UTC+01:00</option>
		<option>UTC+02:00</option>
		<option>UTC+03:00</option>
		<option>UTC+04:00</option>
		<option>UTC+05:00</option>
		<option>UTC+06:00</option>
		<option>UTC+07:00</option>
		<option>UTC+08:00</option>
		<option>UTC+09:00</option>
		<option>UTC+10:00</option>
		<option>UTC+11:00</option>
		<option>UTC+12:00</option>
		<option>UTC+13:00</option>
		<option>UTC+14:00</option>
	</select>
</div>

<div class="outer_frame" >
    <p>Optionen</p>
    <div style="text-align: left;" >
        <label><input type="checkbox" name="heartbeat" id="heartbeat" onchange="changeVar(this.id, this.checked)">Heartbeat</label><br/>
        <label><input type="checkbox" name="itIs" id="itIs" onchange="changeVar(this.id, this.checked)">"Es ist" anzeigen</label><br/>
        <label><input type="checkbox" name="rainbow" id="rainbow" onchange="changeVar(this.id, this.checked)">Rainbow</label>
        <select style="width: 55%;" name="rainbowSpeed" id="rainbowSpeed" onchange="changeVar(this.id, this.value)">
            <option>langsam</option>
            <option>mittel</option>
            <option>schnell</option>
        </select>
    </div>
</div>

<div class="outer_frame">
    <p>Ausschalt-Automatik</p>
    <div style="text-align: left;" >
    <label><input type="checkbox" name="autoOnOff" id="autoOnOff" onchange="changeVar(this.id, this.checked)">aktiv</label>
    <input type="time" id="autoOn" style="width: 6em;" onchange="changeVar(this.id, this.value)"> - 
    <input type="time" style="width: 6em;" id="autoOff" onchange="changeVar(this.id, this.value)"> 
</div>
</div>

<div class="outer_frame">
    <p>Zeitserver</p>
    <input type="text" class="ntp_input" id="ntpserver" value="wird geladen..." onkeyup="changeIP(this.id, this.value)">
</div>

<script>
    var lastBackground = '';
    var newBackground = '';
    var lastForeground = '';
    var newForeground = '';
    var lastSeconds = '';
    var newSeconds = '';

    var timer = setTimeout(sendColorTimer, 250);

    let myhost = "http://" + location.hostname + (location.port ? ':'+location.port : '');

    const timers = {};

    function changeIP( varname, value) {
        if( isValidIP(v) ) {
            changeVar(n,v);
        }
    }

    function changeVar( varname, value ) {
        clearTimeout(timers[varname]);
        timers[varname] = setTimeout((n,v)=>{
            if( v === true ) v = 1;
            if( v === false ) v = 0;
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", myhost + "/setvar?name="+n+"&value=" + v, true);
            xhttp.send(); 
        }, 500, varname, value );
    }
	
    function updateButton(id, text, r, g, b)
    {
        button = document.getElementById(id);
        button.jscolor.fromRGB(r, g, b);
        button.innerHTML = text;
        return button.jscolor.toString();
    }
    
    function httpget(path, readycb) {
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if(xhttp.readyState == 4 ) {
                if( xhttp.status == 200 ) {
                    console.log("GET "+path+" -> "+xhttp.responseText);
                    readycb(xhttp.responseText);
                } else {
                    console.error("http get to '"+path+"' resulted in "+xhttp.status);
                }
            }
        };
        xhttp.open("GET", myhost + path, true);
        xhttp.send();
    }

    function loadColors() {
        httpget( "/getcolors", (res) => {
            let c = res.split(',');
            newBackground = updateButton('backgroundColorButton', 'Hintergrund', c[0], c[1], c[2]);
            newForeground = updateButton('foregroundColorButton', 'Vordergrund', c[3], c[4], c[5]);
            newSeconds = updateButton('secondsColorButton', 'Sekunden', c[6], c[7], c[8]);
        });
    }

    function sendColorTimer()
    {
        var update = false;

        if(newBackground != '' && newBackground != lastBackground)
        {
            lastBackground = newBackground;
            update = true;
        }
        if(newForeground != '' && newForeground != lastForeground)
        {
            lastForeground = newForeground;
            update = true;
        }
        if(newSeconds != '' && newSeconds != lastSeconds)
        {
            lastSeconds = newSeconds;
            update = true;
        }

        if(newSeconds == '' || newBackground == '' || newForeground == '')
        {
            update = false;
        }

        if(update == true)
        {
            var request = myhost + "/setcolor?" 
                + "bg=" + newBackground 
                + "&fg=" + newForeground 
                + "&s=" + newSeconds;
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", request, true);
            xhttp.send();
        }

        timer = setTimeout(sendColorTimer, 250);
    }

    function isValidIP(ip)
    {
        var s = ip.split('.');
        if(s.length != 4) return false;
        for(var i=0; i<3; i++)
        {
            if(s[i] == '') return false;
            if(isNaN(s[i])) return false;
            var n = parseInt(s[i]);
            if(n < 0 || n > 255) return false;
        }
        return true;
    }

	function loadTimeZone() {
        httpget( "/gettimezone", (res) => {
            document.getElementById('timezone').selectedIndex = parseInt(res) + 12;
        });
	}

    function loadVars() {
        const vars = ['itIs', 'rainbow', 'rainbowSpeed', 'autoOnOff', 'autoOn', 'autoOff', 'mode', 'heartbeat', 'ntpserver'];
        for( const v of vars) {
            httpget( "/getvar?name=" + v, (res) => {
                const e = document.getElementById(v);
                if( e ) {
                    if(e.type === 'checkbox') e.checked = (res == "1" || res == "true");
                    if(e.type === 'time' || e.type === 'text') e.value = res;
                    if(e.type === 'select-one' ) e.selectedIndex = parseInt(res);
                }              
            });
        }
    }
	
    function loadSettings()
    {
        loadColors();
		loadTimeZone();
        loadVars();
    }
    
</script>


</body>
</html>